스패닝 트리로 가는 첫번째 관문 두 가지
---------
스패닝 트리 알고리즘: 스위치나 브리지에서 발생하는 루핑을 막아주기 위한 프로토콜  
  
STP를 이해하기 위한 개념 두 가지
1. 브리지 ID : 브리지나 스위치들이 통신할 때 서로를 확인하기 위해 하나씩 가지고 있는 번호
  - 16비트의 Bridge Priority와 48비트의 맥 어드레스로 만들어짐
  - 브리지 우선순위
    - 16비트로 만들어지기 때문에 올 수 있는 수는 0부터 2의 16승-1 -> 0~65535
    - 디폴트로 중간값인 32768을 이용
  - 맥 어드레스
    - Bridge priority 뒤에 옴. 48비트
    - 스위치에 고정되어 있는 값
2. Path Cost
  - 원래 스패닝 트리 프로토콜을 정의하고 있는 IEEE 802.1D에서는 이 Cost 값을 계산할 때 1000Mbps를 두 장비 사이의 링크 대역폭으로 나눈 값을 이용함
  - Path Cost는 링크의 속도(대역폭)가 빠르면 빠를수록 더 작은 값이 됨
  - 예전에는 1000을 자기 속도로 나눈 값을 썼는데 다양한 속도가 나오면서, 이를 막기 위해 IEEE는 정수값으로 Path Cost 값을 지정
  
스패닝 트리를 잘하려면 세 가지만 기억하세요
---------------------
1. 네트워크당 하나의 루트 브리지를 갖는다
  - 네트워크 : 라우터에 의해 나누어지는 브로드캐스트 도메인이 하나의 네트워크
  - 루트 브리지 : 대장 브리지. 스패닝 트리 프로토콜을 수행할 때 기준이 되는 브리지.
2. 루트 브리지가 아닌 나머지 모든 브리지(Non Root Bridge)는 무조건 하나씩의 루트 포트를 갖는다
  - 루트 포트 : 루트 브리지에 가장 빨리 갈 수 있는 포트. 즉 루트 브리지 쪽에 가장 가까운 포트.
  - 네트워크 당 하나씩 루트 브리지가 있으므로 루트 브리지를 제외한 나머지 모든 브리지는 자동으로 Non Root Bridge가 됨
  - 나머지 브리지들은 루트 브리지쪽으로 가장 가까이 있는 루트 포트를 하나씩 지정해 주어야함.
3. 세그먼트당 하나씩의 데지그네이티드 포트를 갖는다
  - 세그먼트 : 브리지 또는 스위치 간에 연결된 링크
  - 브리지나 스위치가 서로 연결되어 있을 때 이 세그먼트에서 반드시 한 포트는 Designated Port로 선출되어야 함
  
스패닝 트리 프로토콜은 이 세 가지 규칙을 적용해서 어느 쪽 링크를 살려두고 어느 쪽 링크를 끊을지 결정하는 과정

STP에서 힘 겨루기
---------------
순서 정하기 4단계
1. 누가 더 작은 Root BID를 가졌는가?
2. 루트 브리지까지의 Path Cost 값은 누가 더 작은가?
3. 누구의 BID(Sender BID)가 더 낮은가?
4. 누구의 포트 ID가 더 낮은가?
  
브리지는 스패닝 트리 정보를 자기들끼리 주고받기 위해서 특수한 프레임을 사용하는데 이를 BPDU(Bridge Protocol Data Unit)라고 함  
브리지나 스위치가 부팅을 하면 이들은 각각의 포트로 BPDU를 매 2초마다 내보내면서 서로의 스패닝 트리 정보를 주고받음  
이 BPDU를 주고 받으면서 누가 루트 브리지이고 어떤 포트가 루트 포트가 될지, 어떤 포트가 데지그네이티드 포트가 될지를 결정.

스위치에서 대장 브리지 뽑기
----------------
대장 브리지를 뽑는 조건 - 낮은 BID를 가지고 있을 것
- 스위치 A의 BID = 32768.1111.1111.1111
- 스위치 B의 BID = 32768.2222.2222.2222
- 스위치 C의 BID = 32768.3333.3333.3333

스위치 B와 C 두 대의 스위치가 부팅을 시작했다고 가정.
서로 BPDU를 주고 받음. 루트 브리지 BID를 자기 자신의 BID로 세팅해서 BPDU를 서로 주고 받음.  
  
스위치 B가 자신의 BPDU를 보내고 얼마 지나지 않아 스위치 C의 BPDU가 도착.
자신의 루트 브리지 BID와 비교, B의 BID가 더 낮음. 스위치 B는 C의 BPDU를 무시해버림.  
  
스위치 C도 자신의 것을 보내고 B의 BID를 받음.  
스위치 B의것이 더 좋은 루트 브리지 ID이므로 자신의 BID를 B의 BID로 바꾸어 다른 곳으로 전송.  
  
스위치 A 부팅 시작.
자신의 BPDU에 루트 브리지의 BID를 자기 BID인 32768.1111.1111.1111로 실어서 양쪽의 스위치 B와 C로 보냄.  
A가 가장 낮으므로 루트 브리지가 됨.   
  
내가 네트워크 관리자인데 스위치 C를 꼭 루트 브리지로 만들고 싶다면?
  - 스위치 C의 BID를 가장 낮게 만들면 됨. 
  - Bridge Priority 값을 더 낮게 만든다.
  
졸병 브리지(Non Root Bridge)의 루트 포트 선출기
--------------
루트 포트를 뽑으려면 우선 Root Path Cost를 알아봐야 함  
그 값이 낮은 포트가 루트 포트가 됨

스패닝 트리의 마지막 단계 Designated Port 뽑기
----------------
스패닝 트리의 세번째 규칙 '세그먼트당 하나씩의 데지그네이티드 포트를 갖는다'  
무엇으로 데지그네이티드 포트를 뽑을까? 루트 브리지까지의 Path cost를 서로 비교해서 더 작은 Root Path Cost를 가진 포트가 데지그네이티드 포트로 선출됨  
루트 브리지의 모든 포트들은 언제나 데지그네이티드 포트로 선정된다.

스패닝 트리 프로토콜의 5가지 상태 변화
-------------
스패닝 트리 프로토콜을 구현해나가는 과정에서 모든 스위치나 브리지의 포트들은 5가지로 상태가 변함.
- Disabled : 포트가 고장나서 사용할 수 없거나 네트워크 관리자가 포트를 일부러 Shut Down 시켜놓은 상태
- Blocking : 스위치를 맨 처음 켜거나 Disabled되어 있는 포트를 관리자가 다시 살렸을 때 그 포트는 블로킹 상태에 들어감. 데이터 전송은 되지 않고 BPDU만 주고 받을 수 있음. 
- Listening : 블로킹 상태에 있던 스위치 포트가 루트 포트나 데지그네이티드 포트로 선정되면 포트는 바로 리스닝 상태로 넘어감. 
- Learning : 리스닝 상태에 있던 스위치 포트가 포워딩 딜레이 디폴트 시간인 15초 동안 그 상태를 계속 유지하면 러닝 상태로 넘어감. 러닝 상태에서야 비로소 맥 어드레스를 배워 맥 어드레스 테이블을 만들게 됨.
- Forwarding : 스위치 포트가 러닝 상태에서 다른 상태로 넘어가지 않고 다시 포워딩 딜레이 디폴트 시간인 15초 동안 그 상태를 유지하면 포워딩 상태로 넘어감. 포워딩 상태가 되면 스위치 포트는 데이터 프레임을 주고받을 수 있음. 
  
스패닝 트리에 변화가 생기던 날
----------
스패닝 트리 재편성을 배우기 전에 용어를 정의해보자
- Hello time : 루트 브리지가 얼마만에 한 번씩 헬로BPDU를 보내는지에 대한 시간. 즉 루트 브리지는 자신에게 연결된 브리지들에게 헬로BPDU를 헬로 타임마다 한 번씩 보내게 되는데, 디폴트 헬로타임은 2초.
- Max Age : 브리지들이 루트 브리지로부터 헬로패킷을 받지 못하면 맥스 에이지 시간동안 기다린 다음 스패닝 트리 구조 변경을 시작함. 즉 맥스 에이지란 브리지들이 루트 브리지로부터 얼마 동안 헬로패킷을 받지 못했을 때 루트 브리지가 죽었다고 생각하고 새로운 스패닝 트리를 만들기 시작하는가에 대한 시간.
- Forwarding Delay: 브리지 포트가 블로킹 상태에서 포워딩 상태로 넘어갈 때까지 걸리는 시간. 사실 블로킹에서 포워딩으로 넘어가는데 걸리는 시간은 포워딩 딜레이 시간의 두 배.
  
브리지에 문제가 생겼을 때 어떻게 브리지가 새로운 스패닝 트리를 만들어갈까?
1. 맨 처음 루트 브리지로부터 헬로패킷을 2초마다 받던 스위치 C에 갑자기 헬로패킷이 들어오지 않게 됨.
2. 스위치 C는 맥스 에이지 시간인 20초 동안 루트 브리지로부터의 헬로패킷을 기다려보지만 20초가 지나도 헬로패킷은 E0 포트를 통해 들어오지 않음.
3. 이렇게 되자 스위치 C는 스위치 B에서 전달해 준 헬로패킷을 자신의 E1 포트로 받아들여 E1 포트를 루트 포트로 세팅하게 됩니다.
4. 물론 Non Designated 포트로 블로킹 상태에 있던 스위치 C의 E1 포트를 루트 포트로 선정했다고 해서 바로 포워딩 상태로 넘어가는 것은 아님. 디폴트 포워딩 딜레이 시간인 15초를 먼저 리스닝 상태에서 기다리고, 다시 한 번 러닝 상태에서 15초를 추가로 기다린 다음 드디어 데이터 전송이 가능한 포워딩 상태로 넘어가게 된다. 이때 기존의 루트 포트로 포워딩 상태였던 스위치 C의 E0 포트는 블로킹이 됨.

카타리스트 스위치 바라보기
-----------
- Catalyst 2960-48PST-L
  - 48 : 포트는 48포트
  - P : PoE를 지원하는 스위치 (PoE : Power over Ethernet. 이더넷 케이블 위에 데이터만 보내는 게 아니고 전원까지 같이 실어 보내는 것)
- Catalyst 2960-PST-L
  - S, T : SFP와 TP 방식의 업링크 포트 제공
    - SFP : Small Form-Factor Pluggable의 약자. 광케이블을 접속하기 위한 접속 방식 중 하나.
- Catalyst 2960-24PC-L
  - 24포트 짜리에 PoE를 지원하는 스위치
  - C : Dual Purpose Uplink 지원. SFP 포트나 Base T 포트 둘 중 하나를 선택해서 사용할 수 있음.
    
스위치의 앞면
- 시스템 LED : 시스템이 전원을 제대로 공급받고 있는지, 장비가 이상 없이 동작하고 있는지를 한눈에 알 수 있게 도와주는 LED
  - 꺼짐 : 전원이 공급되고 있지 않은 꺼진 상태
  - 초록색 : 시스템이 정상적으로 동작중
  - 주황색 : 전원은 공급되나 비정상적으로 작동중
- RPS LED : Redundant Power Supply. 보조 전원 공급 장치의 상태를 보기 위한 LED
  - 꺼짐 : RPS가 꺼져 있거나 제대로 연결되어 있지 않다
  - 초록색 : RPS가 연결되어 있고 정상 작동중이다
  - 초록색으로 깜빡임 : RPS가 연결되어 있으나, 현재 다른 스위치에 전원을 공급 중이어서 현재 스위치에 전원 공급이 불가능하다.
  - 주황색 : RPS가 대기 모드에 있거나 고장이다. 이때 RPS에 있는 Stanby/Active 버튼을 눌러주면 LED는 녹색으로 바뀐다. 그러나 만약 녹색으로 바뀌지 않는다면 RPS 고장이다.
  - 주황색으로 깜빡임 : 스위치의 내부 전원 고장으로 RPS로부터 전원을 공급받아 동작중이다.
- 포트모드 LED : 각 스위치 포트 위에 있는 포트모드 LED가 무엇을 나타내고 있는가를 알려줌
  - STAT : Port Status. 각 포트의 상태를 표시(디폴트)
  - DUPLX : Part Duplex Mode. 각 포트의 듀플렉스 모드 표시(Half/Full)
  - SPEED : Port Speed. 각 포트의 스피드(10/100/1000)를 표시
  - PoE : PoE Port Power. 포트 별 PoE의 상태 표시
  
스위치의 뒷면
- 콘솔 포트
- 쿨링팬
- RPS연결부
- 전원 케이블 연결부
  
카타리스트 스위치 구성하기
---------
  
디폴트 구성
- Status : notconnect
- Vlan : 1
- Duplex : Auto
  - 통신방식. Half Duplex는 한 번에 한쪽에서만 전송(무전기), Full Duplex는 동시에 양방향에서 전송(전화기)
  - Auto는 상대편의 상태에 따라 내가 맞추겠다는 것
- Speed : Auto
  - 이 스위치는 10Mbps와 100Mbps 둘 다 가능한데 상대방의 속도에 맞추겠다는 것
  
- Spanning Tree 상태? Enable
  - 스패닝 트리 프로토콜은 세팅하지 않아도 자동으로 활성화, 루핑을 방지
- IP 주소 세팅
  - 왜 IP 주소를 세팅할까? 스위치를 제대로 관리하기 위해서. 나중에 스위치 구성을 확인하거나 변경할 때 텔넷을 이용한 접속 가능
  - 스위치의 어디에 IP 주소를 부여할까? 스위치는 라우터와 달리 모든 인터페이스에 IP 주소를 부여하지 않고 대표로 하나의 주소만을 부여
  
맥 어드레스는 어디에 저장되어 있을까요?
--------
맥 어드레스는 스위치나 브리지가 출발지에서 들어오는 맥 어드레스를 보고 그것을 자신의 맥 어드레스 테이블에 저장한 다음, 그 주소 테이블에 있는 맥 어드레스를 찾으면 그쪽 포트로만 보내고 나머지 포트는 막아줌으로써 스위치의 기본 기능 중 하나인 콜리전 도메인을 막음.  
  
시스코 스위치가 맥 어드레스를 저장하는 방식 두 가지
- Dynamic 방식
  - 자동으로 배우는 방식, 디폴트.
  - 맥 어드레스를 하나 배우고 나면 그것을 테이블에 저장하고 사용. 이 주소를 사용한지 300초(디폴트)가 지나도록 다시 사용하지 않으면 이 주소는 MAC 테이블에서 지워짐
- Permanent 방식
  - 수동으로 맥 어드레스를 넣어주는 방식
  - 영원히 지워지지 않음
  
가상의 랜(Virtual LAN)이란?
----------
- 브로드캐스트의 영향이 점차 커지면서 라우터에 의한 네트워크 영역의 분류는 필수가 됨. 그래서 하나의 스위치에 연겨뢴 모든 방비들이 모두 같은 브로드캐스트 도메인 안에 있게 됨. 이러한 브로드캐스트 도메인을 나누려면 중간에 라우터를 두고 양쪽으로 스위치를 라우터에 연결해야함.
- VLAN을 사용하면 한 대의 스위치를 마치 여러 대의 분리된 스위치처럼 사용하고, 여러 개의 네트워크 정보를 하나의 포트를 통해 전송할 수 있음.

VLAN에서 꼭 기억해야할 몇 가지
-------------
- VLAN은 스위치에서 지원하는 기능
- VLAN은 한 대의 스위치를 여러 개의 네트워크로 나누기 위해 사용
- 스위치 안에 있는 스위치 각각을 VLAN이라고 함
- 하나의 포트를 통해 서로 다른 여러 개의 VLAN을 전송할 수 있게 하는 포트를 트렁크 포트라고 함

VLAN에서의 트렁킹과 VTP(VLAN Trunking Protocol)
----------
트렁킹은 여러 개의 VLAN을 함께 실어나르는 것.  
셔틀버스처럼 모든 VLAN이 하나의 링크를 통해 다른 스위치나 라우터로 이동하기 위해 트렁킹이라는 것을 만듦.  
자기 집을 제대로 찾아가려면 각 VLAN 별로 이름표가 있어야 함.  
이 이름표를 어떻게 붙여주느냐에 따라 트렁킹도 두 가지 방식이 있음.
1. ISL 트렁킹
  - 시스코에서 반든 트렁킹 프로토콜. 시스코 장비끼리만 사용
  - 스위치와 스위치 간의 링크, 스위치와 라우터 간의 링크에서 여러 개의 VLAN 정보를 함께 전달하는 방식
  - 네이티브 VLAN이란 개념이 없어 모든 VLAN에 이름표를 붙임
2. IEEEE802.1Q 트렁킹
  - Catalyst 2950이 지원
  - 표준 트렁크 프로토콜
  - 네이티브 VLAN 사용
    - 이름표를 붙이지 않는 VLAN. 
    - 모든 스위치 네트워크에서 유일하게 한 개의 VLAN만을 네이티브 VLAN으로 세팅할 수 있음
  
VTP
- 스위치들 에 VLAN 정보를 서로 주고받아 스위치들이 가지고 있는 VLAN 정보를 항상 일치시켜 주기 위한 프로토콜
- VTP가 enable 되도록 구성하면 모든 스위치에 일일이 VLAN 정보를 업데이트할 필요가 없음
  
VTP 간에 주고받는 메시지 형식
1. Summary Advertisement : VTP 서버가 자신에게 연결되어 있는 스위치들에게 매 5분마다 한 번씩 전달하는 메시지. 
2. Subset Advertisement : VLAN 구성이 변경되었을 때나 VTP 클라이언트로부터 Advertisement Request 메시지를 받았을 때 전송됨
3. Advertisement Request : 클라이언트가 VTP 서버에게 Summary Advertisement와 Subset Advertisement를 요청하는 용도로 사용됨
  
스위치의 디폴트 구성
- VTP Domain Name = null
- VTP Mode = Server
- Config Revision = 0
- Vlan = 1
  
VTP의 세 가지 모드
1. VTP 서버 모드: VLAN을 생성, 삭제, VLAN의 이름을 바꿔줄 수 있음. VTP 도메인 안에 있는 나머지 스위치들에게 VTP 도메인 이름과 VLAN 구성, Configuration Revision넘버를 전달해줄 수 있음. 
2. VTP 클라이언트 모드 : VLAN 삭제, 이름 변경 불가능. VTP 서버가 전달해준 VLAN 정보를 받고, 받은 정보를 자기와 연결된 다른쪽 스위치에 전달하는 것만 가능.
3. VTP 트랜스페어런트 모드 : VTP 도메인 영역 안에 있지만 자신의 VLAN을 업데이트하거나 자신의 VLAN을 업데이트한 정보를 다른 스위치에게 전달하지 않음. 남들의 VTP 메시지는 전달해주되 자기는 관여하지 않는 것.
252
