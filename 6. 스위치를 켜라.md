스패닝 트리로 가는 첫번째 관문 두 가지
---------
스패닝 트리 알고리즘: 스위치나 브리지에서 발생하는 루핑을 막아주기 위한 프로토콜  
  
STP를 이해하기 위한 개념 두 가지
1. 브리지 ID : 브리지나 스위치들이 통신할 때 서로를 확인하기 위해 하나씩 가지고 있는 번호
  - 16비트의 Bridge Priority와 48비트의 맥 어드레스로 만들어짐
  - 브리지 우선순위
    - 16비트로 만들어지기 때문에 올 수 있는 수는 0부터 2의 16승-1 -> 0~65535
    - 디폴트로 중간값인 32768을 이용
  - 맥 어드레스
    - Bridge priority 뒤에 옴. 48비트
    - 스위치에 고정되어 있는 값
2. Path Cost
  - 원래 스패닝 트리 프로토콜을 정의하고 있는 IEEE 802.1D에서는 이 Cost 값을 계산할 때 1000Mbps를 두 장비 사이의 링크 대역폭으로 나눈 값을 이용함
  - Path Cost는 링크의 속도(대역폭)가 빠르면 빠를수록 더 작은 값이 됨
  - 예전에는 1000을 자기 속도로 나눈 값을 썼는데 다양한 속도가 나오면서, 이를 막기 위해 IEEE는 정수값으로 Path Cost 값을 지정
  
스패닝 트리를 잘하려면 세 가지만 기억하세요
---------------------
1. 네트워크당 하나의 루트 브리지를 갖는다
  - 네트워크 : 라우터에 의해 나누어지는 브로드캐스트 도메인이 하나의 네트워크
  - 루트 브리지 : 대장 브리지. 스패닝 트리 프로토콜을 수행할 때 기준이 되는 브리지.
2. 루트 브리지가 아닌 나머지 모든 브리지(Non Root Bridge)는 무조건 하나씩의 루트 포트를 갖는다
  - 루트 포트 : 루트 브리지에 가장 빨리 갈 수 있는 포트. 즉 루트 브리지 쪽에 가장 가까운 포트.
  - 네트워크 당 하나씩 루트 브리지가 있으므로 루트 브리지를 제외한 나머지 모든 브리지는 자동으로 Non Root Bridge가 됨
  - 나머지 브리지들은 루트 브리지쪽으로 가장 가까이 있는 루트 포트를 하나씩 지정해 주어야함.
3. 세그먼트당 하나씩의 데지그네이티드 포트를 갖는다
  - 세그먼트 : 브리지 또는 스위치 간에 연결된 링크
  - 브리지나 스위치가 서로 연결되어 있을 때 이 세그먼트에서 반드시 한 포트는 Designated Port로 선출되어야 함
  
스패닝 트리 프로토콜은 이 세 가지 규칙을 적용해서 어느 쪽 링크를 살려두고 어느 쪽 링크를 끊을지 결정하는 과정

STP에서 힘 겨루기
---------------
순서 정하기 4단계
1. 누가 더 작은 Root BID를 가졌는가?
2. 루트 브리지까지의 Path Cost 값은 누가 더 작은가?
3. 누구의 BID(Sender BID)가 더 낮은가?
4. 누구의 포트 ID가 더 낮은가?
  
브리지는 스패닝 트리 정보를 자기들끼리 주고받기 위해서 특수한 프레임을 사용하는데 이를 BPDU(Bridge Protocol Data Unit)라고 함  
브리지나 스위치가 부팅을 하면 이들은 각각의 포트로 BPDU를 매 2초마다 내보내면서 서로의 스패닝 트리 정보를 주고받음  
이 BPDU를 주고 받으면서 누가 루트 브리지이고 어떤 포트가 루트 포트가 될지, 어떤 포트가 데지그네이티드 포트가 될지를 결정.

스위치에서 대장 브리지 뽑기
----------------
대장 브리지를 뽑는 조건 - 낮은 BID를 가지고 있을 것
- 스위치 A의 BID = 32768.1111.1111.1111
- 스위치 B의 BID = 32768.2222.2222.2222
- 스위치 C의 BID = 32768.3333.3333.3333

스위치 B와 C 두 대의 스위치가 부팅을 시작했다고 가정.
서로 BPDU를 주고 받음. 루트 브리지 BID를 자기 자신의 BID로 세팅해서 BPDU를 서로 주고 받음.  
  
스위치 B가 자신의 BPDU를 보내고 얼마 지나지 않아 스위치 C의 BPDU가 도착.
자신의 루트 브리지 BID와 비교, B의 BID가 더 낮음. 스위치 B는 C의 BPDU를 무시해버림.  
  
스위치 C도 자신의 것을 보내고 B의 BID를 받음.  
스위치 B의것이 더 좋은 루트 브리지 ID이므로 자신의 BID를 B의 BID로 바꾸어 다른 곳으로 전송.  
  
스위치 A 부팅 시작.
자신의 BPDU에 루트 브리지의 BID를 자기 BID인 32768.1111.1111.1111로 실어서 양쪽의 스위치 B와 C로 보냄.  
A가 가장 낮으므로 루트 브리지가 됨.   
  
내가 네트워크 관리자인데 스위치 C를 꼭 루트 브리지로 만들고 싶다면?
  - 스위치 C의 BID를 가장 낮게 만들면 됨. 
  - Bridge Priority 값을 더 낮게 만든다.
  
졸병 브리지(Non Root Bridge)의 루트 포트 선출기
--------------
루트 포트를 뽑으려면 우선 Root Path Cost를 알아봐야 함  
그 값이 낮은 포트가 루트 포트가 됨

스패닝 트리의 마지막 단계 Designated Port 뽑기
----------------
스패닝 트리의 세번째 규칙 '세그먼트당 하나씩의 데지그네이티드 포트를 갖는다'  
무엇으로 데지그네이티드 포트를 뽑을까? 루트 브리지까지의 Path cost를 서로 비교해서 더 작은 Root Path Cost를 가진 포트가 데지그네이티드 포트로 선출됨  
루트 브리지의 모든 포트들은 언제나 데지그네이티드 포트로 선정된다.

스패닝 트리 프로토콜의 5가지 상태 변화
-------------
스패닝 트리 프로토콜을 구현해나가는 과정에서 모든 스위치나 브리지의 포트들은 5가지로 상태가 변함.
- Disabled : 포트가 고장나서 사용할 수 없거나 네트워크 관리자가 포트를 일부러 Shut Down 시켜놓은 상태
- Blocking : 스위치를 맨 처음 켜거나 Disabled되어 있는 포트를 관리자가 다시 살렸을 때 그 포트는 블로킹 상태에 들어감. 데이터 전송은 되지 않고 BPDU만 주고 받을 수 있음. 
- Listening : 블로킹 상태에 있던 스위치 포트가 루트 포트나 데지그네이티드 포트로 선정되면 포트는 바로 리스닝 상태로 넘어감. 
- Learning : 리스닝 상태에 있던 스위치 포트가 포워딩 딜레이 디폴트 시간인 15초 동안 그 상태를 계속 유지하면 러닝 상태로 넘어감. 러닝 상태에서야 비로소 맥 어드레스를 배워 맥 어드레스 테이블을 만들게 됨.
- Forwarding : 스위치 포트가 러닝 상태에서 다른 상태로 넘어가지 않고 다시 포워딩 딜레이 디폴트 시간인 15초 동안 그 상태를 유지하면 포워딩 상태로 넘어감. 포워딩 상태가 되면 스위치 포트는 데이터 프레임을 주고받을 수 있음. 

213
